<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TeamWellness - Panel del Entrenador</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: 'Segoe UI', sans-serif; background: #f3f4f6; }

/* Login & Activation */
.auth-screen { position: fixed; inset: 0; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; z-index: 1000; }
.auth-screen.hidden { display: none; }
.auth-box { background: white; padding: 40px; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); width: 90%; max-width: 500px; }
.auth-box h1 { color: #667eea; font-size: 2.5em; margin-bottom: 10px; text-align: center; }
.auth-box .subtitle { color: #6b7280; margin-bottom: 30px; text-align: center; }
.auth-tabs { display: flex; gap: 10px; margin-bottom: 30px; }
.auth-tab { flex: 1; padding: 12px; background: #f3f4f6; border: none; border-radius: 10px; cursor: pointer; font-weight: 600; color: #6b7280; }
.auth-tab.active { background: #667eea; color: white; }
.form-group { margin-bottom: 20px; }
.form-group label { display: block; margin-bottom: 8px; font-weight: 600; color: #374151; }
.form-input { width: 100%; padding: 15px; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 1em; }
.form-input:focus { outline: none; border-color: #667eea; }
.btn-primary { width: 100%; padding: 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 10px; font-size: 1.1em; font-weight: bold; cursor: pointer; }
.btn-primary:hover { transform: translateY(-2px); box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4); }
.error-message { color: #ef4444; background: #fee2e2; padding: 10px; border-radius: 8px; margin-top: 15px; display: none; }
.error-message.show { display: block; }

/* Main App */
.app-screen { display: none; }
.app-screen.show { display: block; }

/* Header */
.header { background: white; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 100; }
.header-content { max-width: 1400px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; }
.header-title { display: flex; align-items: center; gap: 15px; }
.header-title h1 { color: #667eea; font-size: 1.8em; }
.team-name { color: #6b7280; font-size: 1em; }
.header-actions { display: flex; gap: 10px; }
.btn-secondary { padding: 10px 20px; background: #f3f4f6; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; }
.btn-danger { background: #ef4444; color: white; }

/* Container */
.container { max-width: 1400px; margin: 0 auto; padding: 30px 20px; }

/* Stats Cards */
.stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px; }
.stat-card { background: white; padding: 25px; border-radius: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
.stat-value { font-size: 2.5em; font-weight: bold; color: #667eea; margin: 10px 0; }
.stat-label { color: #6b7280; font-size: 0.9em; }
.stat-icon { font-size: 2.5em; }

/* Sections */
.section { background: white; padding: 30px; border-radius: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 30px; }
.section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
.section-title { font-size: 1.5em; color: #374151; }

/* Tabs */
.tabs { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #e5e7eb; }
.tab { padding: 12px 24px; background: none; border: none; border-bottom: 3px solid transparent; cursor: pointer; font-weight: 600; color: #6b7280; transition: all 0.3s; }
.tab.active { color: #667eea; border-bottom-color: #667eea; }

/* Players Grid */
.players-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }
.player-card { background: #f9fafb; padding: 20px; border-radius: 12px; border-left: 4px solid #e5e7eb; transition: all 0.3s; }
.player-card:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
.player-card.critical { border-left-color: #ef4444; }
.player-card.warning { border-left-color: #f97316; }
.player-card.caution { border-left-color: #fbbf24; }
.player-card.good { border-left-color: #10b981; }
.player-card.pending { border-left-color: #9ca3af; }
.player-header { display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px; }
.player-info { flex: 1; }
.player-name { font-size: 1.2em; font-weight: bold; color: #374151; }
.player-number { background: #667eea; color: white; padding: 5px 12px; border-radius: 8px; font-weight: bold; font-size: 0.9em; display: inline-block; margin-top: 5px; }
.player-status { font-size: 2em; }
.player-details { font-size: 0.9em; color: #6b7280; margin-top: 10px; }
.player-details div { margin: 5px 0; }
.player-actions { display: flex; gap: 8px; margin-top: 15px; }
.btn-small { padding: 8px 16px; background: #667eea; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.9em; }
.btn-small:hover { background: #5568d3; }

/* Modal */
.modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 2000; align-items: center; justify-content: center; }
.modal.show { display: flex; }
.modal-content { background: white; padding: 40px; border-radius: 20px; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto; }
.modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
.modal-title { font-size: 1.8em; color: #374151; }
.btn-close { background: none; border: none; font-size: 2em; cursor: pointer; color: #6b7280; }

/* Table */
.table { width: 100%; border-collapse: collapse; }
.table th { background: #f9fafb; padding: 15px; text-align: left; font-weight: 600; color: #374151; border-bottom: 2px solid #e5e7eb; }
.table td { padding: 15px; border-bottom: 1px solid #e5e7eb; }
.table tr:hover { background: #f9fafb; }

/* Alerts */
.alert { background: #fee2e2; border-left: 4px solid #ef4444; padding: 15px; border-radius: 8px; margin-bottom: 15px; }
.alert.high { background: #fef3c7; border-left-color: #f97316; }
.alert.medium { background: #dbeafe; border-left-color: #3b82f6; }
.alert-header { display: flex; justify-content: space-between; align-items: center; font-weight: 600; margin-bottom: 5px; }
.alert-time { font-size: 0.85em; color: #6b7280; }

@media (max-width: 768px) {
    .stats-grid { grid-template-columns: 1fr; }
    .players-grid { grid-template-columns: 1fr; }
    .header-content { flex-direction: column; gap: 15px; }
}
</style>
</head>
<body>

<!-- Authentication Screen -->
<div class="auth-screen" id="authScreen">
    <div class="auth-box">
        <h1>üí™ TeamWellness</h1>
        <p class="subtitle">Panel del Entrenador</p>
        
        <!-- Activation Form (Siempre visible) -->
        <div id="activateForm">
            <div class="form-group">
                <label>C√≥digo de Licencia</label>
                <input type="text" id="activateLicense" class="form-input" placeholder="TWEL-2025-XXXX">
            </div>
            <div class="form-group">
                <label>Nombre del Equipo</label>
                <input type="text" id="activateTeamName" class="form-input" placeholder="CD Sevilla">
            </div>
            <div class="form-group">
                <label>Tu Nombre (Entrenador)</label>
                <input type="text" id="activateCoachName" class="form-input" placeholder="Juan Mart√≠nez">
            </div>
            <div class="form-group">
                <label>Crear Contrase√±a</label>
                <input type="password" id="activatePassword" class="form-input">
            </div>
            <button class="btn-primary" onclick="handleActivation()">‚úÖ Activar Licencia</button>
            <div class="error-message" id="activateError"></div>
            <p style="margin-top:15px; font-size:0.9em; color:#6b7280;">
                C√≥digos de demo: TWEL-2025-0001, TWEL-2025-0002, TWEL-2025-DEMO
            </p>
        </div>
    </div>
</div>

<!-- Main App -->
<div class="app-screen" id="appScreen">
    <!-- Header -->
    <div class="header">
        <div class="header-content">
            <div class="header-title">
                <div>
                    <h1>üí™ TeamWellness</h1>
                    <div class="team-name" id="teamNameDisplay"></div>
                </div>
            </div>
            <div class="header-actions">
                <button class="btn-secondary" onclick="showSettings()">‚öôÔ∏è Configuraci√≥n</button>
                <button class="btn-secondary btn-danger" onclick="logout()">Salir</button>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="container">
        <!-- Stats -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon">üë•</div>
                <div class="stat-value" id="statTotalPlayers">0</div>
                <div class="stat-label">Jugadores Activos</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">‚úÖ</div>
                <div class="stat-value" id="statCompletedToday">0</div>
                <div class="stat-label">Check-ins Hoy</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">üü¢</div>
                <div class="stat-value" id="statAvailable">0</div>
                <div class="stat-label">Disponibles</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">‚ö†Ô∏è</div>
                <div class="stat-value" id="statAlerts">0</div>
                <div class="stat-label">Alertas Activas</div>
            </div>
        </div>

        <!-- Tabs -->
        <div class="tabs">
            <button class="tab active" onclick="switchTab('dashboard')">Dashboard</button>
            <button class="tab" onclick="switchTab('players')">Gesti√≥n Jugadores</button>
            <button class="tab" onclick="switchTab('alerts')">Alertas</button>
        </div>

        <!-- Dashboard Tab -->
        <div class="section" id="dashboardTab">
            <div class="section-header">
                <h2 class="section-title">Estado del Equipo Hoy</h2>
                <div>
                    <select id="filterStatus" onchange="filterPlayers()" style="padding:8px 12px; border-radius:6px; border:2px solid #e5e7eb;">
                        <option value="all">Todos</option>
                        <option value="pending">Pendientes</option>
                        <option value="good">Disponibles</option>
                        <option value="caution">Precauci√≥n</option>
                        <option value="warning">Advertencia</option>
                        <option value="critical">Cr√≠ticos</option>
                    </select>
                </div>
            </div>
            <div class="players-grid" id="playersGrid"></div>
        </div>

        <!-- Players Management Tab -->
        <div class="section" id="playersTab" style="display:none;">
            <div class="section-header">
                <h2 class="section-title">Gesti√≥n de Jugadores</h2>
                <button class="btn-primary" style="width:auto; padding:12px 24px;" onclick="showAddPlayerModal()">‚ûï A√±adir Jugador</button>
            </div>
            <table class="table" id="playersTable">
                <thead>
                    <tr>
                        <th>Nombre</th>
                        <th>Dorsal</th>
                        <th>Posici√≥n</th>
                        <th>PIN</th>
                        <th>√öltimo Check-in</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody id="playersTableBody"></tbody>
            </table>
        </div>

        <!-- Alerts Tab -->
        <div class="section" id="alertsTab" style="display:none;">
            <div class="section-header">
                <h2 class="section-title">Alertas del Equipo</h2>
            </div>
            <div id="alertsList"></div>
        </div>
    </div>
</div>

<!-- Modal Add Player -->
<div class="modal" id="addPlayerModal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="modal-title">‚ûï A√±adir Jugador</h2>
            <button class="btn-close" onclick="closeModal('addPlayerModal')">&times;</button>
        </div>
        <div class="form-group">
            <label>Nombre Completo</label>
            <input type="text" id="newPlayerName" class="form-input" placeholder="Miguel Ruiz">
        </div>
        <div class="form-group">
            <label>N√∫mero de Dorsal</label>
            <input type="number" id="newPlayerNumber" class="form-input" min="1" max="99" placeholder="10">
        </div>
        <div class="form-group">
            <label>Posici√≥n (opcional)</label>
            <input type="text" id="newPlayerPosition" class="form-input" placeholder="Delantero">
        </div>
        <button class="btn-primary" onclick="addPlayer()">‚úÖ A√±adir Jugador</button>
        <div class="error-message" id="addPlayerError"></div>
    </div>
</div>

<!-- Modal Player Details -->
<div class="modal" id="playerDetailsModal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="modal-title" id="playerDetailsName"></h2>
            <button class="btn-close" onclick="closeModal('playerDetailsModal')">&times;</button>
        </div>
        <div id="playerDetailsContent"></div>
    </div>
</div>

<!-- Modal Settings -->
<div class="modal" id="settingsModal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="modal-title">‚öôÔ∏è Configuraci√≥n</h2>
            <button class="btn-close" onclick="closeModal('settingsModal')">&times;</button>
        </div>
        <div class="form-group">
            <label>Hora L√≠mite Check-in</label>
            <div style="display:flex; gap:10px;">
                <input type="number" id="settingsHour" class="form-input" min="0" max="23" style="width:80px;" placeholder="17">
                <span style="padding:15px;">:</span>
                <input type="number" id="settingsMinutes" class="form-input" min="0" max="59" style="width:80px;" placeholder="00">
            </div>
        </div>
        <button class="btn-primary" onclick="saveSettings()">üíæ Guardar Configuraci√≥n</button>
    </div>
</div>

<script src="js/data.js"></script>
<script>
// Global vars
let currentTeamId = null;
let teamManager = null;
let playerManager = null;
let checkInManager = null;
let alertManager = null;
let sessionManager = null;

// Initialize managers after DOM loads
window.addEventListener('DOMContentLoaded', function() {
    teamManager = new TeamManager();
    sessionManager = new SessionManager();
    
    const session = sessionManager.get();
    if (session && session.type === 'coach') {
        currentTeamId = session.teamId;
        initManagers();
        showApp();
    }
<script>
// ============================================
// TEAMWELLNESS - SISTEMA DE GESTI√ìN DE DATOS
// ============================================

// Generador de IDs √∫nicos
function generateId() {
    return 'tw_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
}

// Generador de PIN √∫nico
function generateUniquePin(existingPins = []) {
    let pin;
    do {
        pin = Math.floor(1000 + Math.random() * 9000).toString();
    } while (existingPins.includes(pin));
    return pin;
}

// ============================================
// GESTI√ìN DE EQUIPOS
// ============================================

class TeamManager {
    constructor() {
        this.prefix = 'teamwellness_';
    }

    // Activar nueva licencia
    activateLicense(licenseCode, teamName, coachName, password) {
        console.log('üîç Validando licencia:', licenseCode);
        
        // Validar c√≥digo de licencia (formato: TWEL-2025-XXXX)
        const validCodes = this.getValidLicenseCodes();
        if (!validCodes.includes(licenseCode)) {
            throw new Error('C√≥digo de licencia inv√°lido');
        }

        // Verificar si ya est√° en uso (permitir re-activar DEMO)
        if (this.isLicenseUsed(licenseCode) && !licenseCode.includes('DEMO')) {
            throw new Error('Esta licencia ya est√° en uso');
        }
        
        // Si es DEMO y ya existe, eliminar el anterior
        if (licenseCode.includes('DEMO')) {
            console.log('üîÑ Limpiando licencia DEMO anterior si existe...');
            const teams = this.getAllTeams();
            teams.forEach(team => {
                if (team.licenseCode === licenseCode) {
                    localStorage.removeItem(`${this.prefix}team_${team.teamId}`);
                    localStorage.removeItem(`${this.prefix}players_${team.teamId}`);
                    localStorage.removeItem(`${this.prefix}checkins_${team.teamId}`);
                    localStorage.removeItem(`${this.prefix}alerts_${team.teamId}`);
                    console.log('üóëÔ∏è Datos anteriores eliminados');
                }
            });
        }

        const teamId = generateId();
        const now = new Date();
        const expiresAt = new Date();
        expiresAt.setFullYear(expiresAt.getFullYear() + 1); // 1 a√±o

        const team = {
            teamId,
            licenseCode,
            teamName,
            coachName,
            coachPassword: password, // En producci√≥n: hash
            createdAt: now.toISOString(),
            activatedAt: now.toISOString(),
            expiresAt: expiresAt.toISOString(),
            maxPlayers: 30,
            settings: {
                deadlineHour: 17,
                deadlineMinutes: 0,
                trainingDays: [1, 2, 3, 4, 5], // L-V
                timezone: 'Europe/Madrid'
            }
        };

        console.log('üíæ Guardando equipo en localStorage...', teamId);
        localStorage.setItem(`${this.prefix}team_${teamId}`, JSON.stringify(team));
        localStorage.setItem(`${this.prefix}players_${teamId}`, JSON.stringify([]));
        localStorage.setItem(`${this.prefix}checkins_${teamId}`, JSON.stringify([]));
        localStorage.setItem(`${this.prefix}alerts_${teamId}`, JSON.stringify([]));
        
        console.log('‚úÖ Equipo guardado correctamente');
        return teamId;
    }

    // Obtener c√≥digos de licencia v√°lidos (en producci√≥n: verificar con servidor)
    getValidLicenseCodes() {
        // Por ahora, c√≥digos de demo
        return [
            'TWEL-2025-0001',
            'TWEL-2025-0002',
            'TWEL-2025-0003',
            'TWEL-2025-0004',
            'TWEL-2025-0005',
            'TWEL-2025-DEMO'
        ];
    }

    // Verificar si licencia ya est√° en uso
    isLicenseUsed(licenseCode) {
        const teams = this.getAllTeams();
        return teams.some(team => team.licenseCode === licenseCode);
    }

    // Obtener todos los equipos
    getAllTeams() {
        const teams = [];
        for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            if (key.startsWith(`${this.prefix}team_`)) {
                const team = JSON.parse(localStorage.getItem(key));
                teams.push(team);
            }
        }
        return teams;
    }

    // Obtener equipo por ID
    getTeam(teamId) {
        const data = localStorage.getItem(`${this.prefix}team_${teamId}`);
        return data ? JSON.parse(data) : null;
    }

    // Actualizar configuraci√≥n del equipo
    updateTeamSettings(teamId, settings) {
        const team = this.getTeam(teamId);
        if (!team) throw new Error('Equipo no encontrado');
        
        team.settings = { ...team.settings, ...settings };
        localStorage.setItem(`${this.prefix}team_${teamId}`, JSON.stringify(team));
        return team;
    }

    // Validar login de entrenador
    validateCoach(licenseCode, password) {
        const teams = this.getAllTeams();
        const team = teams.find(t => t.licenseCode === licenseCode);
        
        if (!team) return null;
        if (team.coachPassword !== password) return null;
        
        return team;
    }
}

// ============================================
// GESTI√ìN DE JUGADORES
// ============================================

class PlayerManager {
    constructor(teamId) {
        this.teamId = teamId;
        this.prefix = 'teamwellness_';
        this.key = `${this.prefix}players_${teamId}`;
    }

    // Obtener todos los jugadores
    getAll() {
        const data = localStorage.getItem(this.key);
        return data ? JSON.parse(data) : [];
    }

    // Obtener jugador por ID
    getById(playerId) {
        const players = this.getAll();
        return players.find(p => p.id === playerId);
    }

    // Obtener jugador por nombre
    getByName(name) {
        const players = this.getAll();
        return players.find(p => p.name === name);
    }

    // A√±adir jugador
    add(name, number, position = '') {
        const players = this.getAll();
        
        // Validar nombre √∫nico
        if (players.some(p => p.name.toLowerCase() === name.toLowerCase())) {
            throw new Error('Ya existe un jugador con ese nombre');
        }

        // Validar dorsal √∫nico
        if (players.some(p => p.number === number)) {
            throw new Error('Ya existe un jugador con ese dorsal');
        }

        const existingPins = players.map(p => p.pin);
        const player = {
            id: generateId(),
            name,
            number: parseInt(number),
            position,
            pin: generateUniquePin(existingPins),
            active: true,
            createdAt: new Date().toISOString(),
            lastCheckIn: null
        };

        players.push(player);
        this.save(players);
        return player;
    }

    // Actualizar jugador
    update(playerId, updates) {
        const players = this.getAll();
        const index = players.findIndex(p => p.id === playerId);
        
        if (index === -1) throw new Error('Jugador no encontrado');
        
        players[index] = { ...players[index], ...updates };
        this.save(players);
        return players[index];
    }

    // Eliminar jugador (soft delete)
    delete(playerId) {
        return this.update(playerId, { active: false });
    }

    // Regenerar PIN
    regeneratePin(playerId) {
        const players = this.getAll();
        const existingPins = players.filter(p => p.id !== playerId).map(p => p.pin);
        const newPin = generateUniquePin(existingPins);
        return this.update(playerId, { pin: newPin });
    }

    // Validar login de jugador
    validateLogin(playerName, pin) {
        const players = this.getAll();
        const player = players.find(p => 
            p.name === playerName && 
            p.pin === pin && 
            p.active
        );
        return player || null;
    }

    // Obtener jugadores activos
    getActive() {
        return this.getAll().filter(p => p.active);
    }

    // Guardar
    save(players) {
        localStorage.setItem(this.key, JSON.stringify(players));
    }
}

// ============================================
// GESTI√ìN DE CHECK-INS
// ============================================

class CheckInManager {
    constructor(teamId) {
        this.teamId = teamId;
        this.prefix = 'teamwellness_';
        this.key = `${this.prefix}checkins_${teamId}`;
    }

    // Obtener todos los check-ins
    getAll() {
        const data = localStorage.getItem(this.key);
        return data ? JSON.parse(data) : [];
    }

    // A√±adir check-in
    add(playerId, playerName, playerNumber, checkInData) {
        const checkIns = this.getAll();
        const now = new Date();

        const team = new TeamManager().getTeam(this.teamId);
        const deadline = new Date();
        deadline.setHours(team.settings.deadlineHour, team.settings.deadlineMinutes, 0, 0);

        const checkIn = {
            id: generateId(),
            teamId: this.teamId,
            playerId,
            playerName,
            playerNumber,
            date: now.toISOString(),
            submitTime: now.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' }),
            onTime: now <= deadline,
            data: checkInData
        };

        checkIns.push(checkIn);
        this.save(checkIns);

        // Actualizar lastCheckIn del jugador
        const playerManager = new PlayerManager(this.teamId);
        playerManager.update(playerId, { lastCheckIn: now.toISOString() });

        // Generar alertas si es necesario
        this.checkForAlerts(checkIn);

        return checkIn;
    }

    // Obtener check-ins de hoy
    getToday() {
        const today = new Date().toDateString();
        return this.getAll().filter(c => 
            new Date(c.date).toDateString() === today
        );
    }

    // Obtener check-ins de un jugador
    getByPlayer(playerId, days = 30) {
        const since = new Date();
        since.setDate(since.getDate() - days);
        
        return this.getAll().filter(c => 
            c.playerId === playerId && 
            new Date(c.date) >= since
        );
    }

    // Obtener √∫ltimo check-in de un jugador
    getLastByPlayer(playerId) {
        const checkIns = this.getByPlayer(playerId, 1);
        return checkIns.length > 0 ? checkIns[checkIns.length - 1] : null;
    }

    // Verificar si jugador complet√≥ check-in hoy
    hasCompletedToday(playerId) {
        const today = this.getToday();
        return today.some(c => c.playerId === playerId);
    }

    // Obtener jugadores pendientes hoy
    getPendingToday() {
        const playerManager = new PlayerManager(this.teamId);
        const players = playerManager.getActive();
        const todayCheckIns = this.getToday();
        const completedIds = todayCheckIns.map(c => c.playerId);
        
        return players.filter(p => !completedIds.includes(p.id));
    }

    // Generar alertas basadas en check-in
    checkForAlerts(checkIn) {
        const alertManager = new AlertManager(this.teamId);
        const data = checkIn.data;

        // Alerta: Dolor severo (9-10)
        if (data.hasPain) {
            Object.entries(data.painZones).forEach(([zone, info]) => {
                if (info.intensity >= 9) {
                    alertManager.add(
                        checkIn.playerId,
                        checkIn.playerName,
                        'severe_pain',
                        'critical',
                        `Dolor cr√≠tico en ${info.label} (${info.intensity}/10)`
                    );
                } else if (info.intensity >= 7) {
                    alertManager.add(
                        checkIn.playerId,
                        checkIn.playerName,
                        'high_pain',
                        'high',
                        `Dolor fuerte en ${info.label} (${info.intensity}/10)`
                    );
                }
            });
        }

        // Alerta: Estado f√≠sico muy bajo
        if (data.physicalState <= 3) {
            alertManager.add(
                checkIn.playerId,
                checkIn.playerName,
                'low_physical',
                'high',
                `Estado f√≠sico muy bajo (${data.physicalState}/10)`
            );
        }

        // Alerta: Poco sue√±o
        if (data.sleepHours < 5) {
            alertManager.add(
                checkIn.playerId,
                checkIn.playerName,
                'low_sleep',
                'medium',
                `Sue√±o insuficiente (${data.sleepHours}h)`
            );
        }
    }

    // Estad√≠sticas
    getStats(days = 7) {
        const since = new Date();
        since.setDate(since.getDate() - days);
        
        const checkIns = this.getAll().filter(c => new Date(c.date) >= since);
        
        if (checkIns.length === 0) {
            return {
                totalCheckIns: 0,
                avgPhysicalState: 0,
                avgMentalState: 0,
                avgFatigue: 0,
                avgSleep: 0,
                playersWithPain: 0
            };
        }

        const sum = (arr) => arr.reduce((a, b) => a + b, 0);
        const avg = (arr) => arr.length > 0 ? sum(arr) / arr.length : 0;

        return {
            totalCheckIns: checkIns.length,
            avgPhysicalState: avg(checkIns.map(c => c.data.physicalState)),
            avgMentalState: avg(checkIns.map(c => c.data.mentalState)),
            avgFatigue: avg(checkIns.map(c => c.data.fatigueLevel)),
            avgSleep: avg(checkIns.map(c => c.data.sleepHours)),
            playersWithPain: checkIns.filter(c => c.data.hasPain).length
        };
    }

    // Guardar
    save(checkIns) {
        localStorage.setItem(this.key, JSON.stringify(checkIns));
    }
}

// ============================================
// GESTI√ìN DE ALERTAS
// ============================================

class AlertManager {
    constructor(teamId) {
        this.teamId = teamId;
        this.prefix = 'teamwellness_';
        this.key = `${this.prefix}alerts_${teamId}`;
    }

    // Obtener todas las alertas
    getAll() {
        const data = localStorage.getItem(this.key);
        return data ? JSON.parse(data) : [];
    }

    // A√±adir alerta
    add(playerId, playerName, type, severity, message) {
        const alerts = this.getAll();
        
        const alert = {
            id: generateId(),
            playerId,
            playerName,
            type,
            severity,
            message,
            date: new Date().toISOString(),
            read: false,
            resolved: false
        };

        alerts.push(alert);
        this.save(alerts);
        return alert;
    }

    // Obtener alertas no le√≠das
    getUnread() {
        return this.getAll().filter(a => !a.read);
    }

    // Obtener alertas activas (no resueltas)
    getActive() {
        return this.getAll().filter(a => !a.resolved);
    }

    // Marcar como le√≠da
    markAsRead(alertId) {
        const alerts = this.getAll();
        const alert = alerts.find(a => a.id === alertId);
        if (alert) {
            alert.read = true;
            this.save(alerts);
        }
    }

    // Marcar como resuelta
    markAsResolved(alertId) {
        const alerts = this.getAll();
        const alert = alerts.find(a => a.id === alertId);
        if (alert) {
            alert.resolved = true;
            alert.read = true;
            this.save(alerts);
        }
    }

    // Guardar
    save(alerts) {
        localStorage.setItem(this.key, JSON.stringify(alerts));
    }
}

// ============================================
// GESTI√ìN DE SESI√ìN
// ============================================

class SessionManager {
    constructor() {
        this.key = 'teamwellness_current_session';
    }

    // Crear sesi√≥n
    create(type, teamId, userId, userName = null) {
        const session = {
            type, // 'coach' | 'player'
            teamId,
            userId,
            userName,
            loginTime: new Date().toISOString()
        };
        localStorage.setItem(this.key, JSON.stringify(session));
        return session;
    }

    // Obtener sesi√≥n actual
    get() {
        const data = localStorage.getItem(this.key);
        return data ? JSON.parse(data) : null;
    }

    // Cerrar sesi√≥n
    clear() {
        localStorage.removeItem(this.key);
    }

    // Verificar si hay sesi√≥n activa
    isActive() {
        return this.get() !== null;
    }
}

// ============================================
// UTILIDADES
// ============================================

const Utils = {
    // Formatear fecha
    formatDate(date) {
        return new Date(date).toLocaleDateString('es-ES', {
            weekday: 'long',
            year: 'numeric',
            month: 'long',
            day: 'numeric'
        });
    },

    // Formatear hora
    formatTime(date) {
        return new Date(date).toLocaleTimeString('es-ES', {
            hour: '2-digit',
            minute: '2-digit'
        });
    },

    // Obtener estado del jugador basado en check-in
    getPlayerStatus(checkIn) {
        if (!checkIn) {
            return { status: 'pending', color: '#9ca3af', icon: '‚ö™', text: 'Pendiente' };
        }

        const physical = checkIn.data.physicalState;
        let maxPain = 0;

        if (checkIn.data.hasPain) {
            maxPain = Math.max(...Object.values(checkIn.data.painZones).map(z => z.intensity));
        }

        if (maxPain >= 9 || physical <= 3) {
            return { status: 'critical', color: '#ef4444', icon: 'üî¥', text: 'Cr√≠tico' };
        } else if (maxPain >= 7 || physical <= 5) {
            return { status: 'warning', color: '#f97316', icon: 'üü†', text: 'Advertencia' };
        } else if (maxPain >= 4 || physical <= 7) {
            return { status: 'caution', color: '#fbbf24', icon: 'üü°', text: 'Precauci√≥n' };
        } else {
            return { status: 'good', color: '#10b981', icon: 'üü¢', text: 'Disponible' };
        }
    },

    // Emojis seg√∫n valor 1-10
    getEmoji(value) {
        const emojis = {
            1: 'üò±', 2: 'üò©', 3: 'üò´', 4: 'üòï', 5: 'üòê',
            6: 'üôÇ', 7: 'üòä', 8: 'üòÑ', 9: 'üòÅ', 10: 'ü§©'
        };
        return emojis[value] || 'üòê';
    }
};
</script>
});

// Remove the old onload
/*
window.onload = function() {
    const session = sessionManager.get();
    if (session && session.type === 'coach') {
        currentTeamId = session.teamId;
        initManagers();
        showApp();
    }
};
*/

// Continue with rest of code
let _oldTeamManager = null;
// (initialized in DOMContentLoaded above)

function initManagers() {
    playerManager = new PlayerManager(currentTeamId);
    checkInManager = new CheckInManager(currentTeamId);
    alertManager = new AlertManager(currentTeamId);
}

// Auth Tab Switch
function switchAuthTab(tab) {
    console.log('üîÑ Cambiando tab a:', tab);
    
    // Remove active from all tabs
    document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
    
    // Add active to the clicked tab
    if (tab === 'login') {
        document.querySelectorAll('.auth-tab')[0].classList.add('active');
    } else {
        document.querySelectorAll('.auth-tab')[1].classList.add('active');
    }
    
    // Show/hide forms
    document.getElementById('loginForm').style.display = tab === 'login' ? 'block' : 'none';
    document.getElementById('activateForm').style.display = tab === 'activate' ? 'block' : 'none';
    
    console.log('‚úÖ Tab cambiado');
}

// Handle Login
function handleLogin() {
    // Ensure managers are initialized
    if (!teamManager) teamManager = new TeamManager();
    if (!sessionManager) sessionManager = new SessionManager();
    
    const license = document.getElementById('loginLicense').value.trim();
    const password = document.getElementById('loginPassword').value;
    
    if (!license || !password) {
        showError('loginError', 'Completa todos los campos');
        return;
    }

    const team = teamManager.validateCoach(license, password);
    if (!team) {
        showError('loginError', 'C√≥digo de licencia o contrase√±a incorrectos');
        return;
    }

    currentTeamId = team.teamId;
    sessionManager.create('coach', currentTeamId, team.teamId);
    initManagers();
    showApp();
}

// Handle Activation
function handleActivation() {
    console.log('üîÑ Iniciando activaci√≥n...');
    
    // Ensure managers are initialized
    if (!teamManager) {
        console.log('üì¶ Inicializando TeamManager...');
        teamManager = new TeamManager();
    }
    if (!sessionManager) {
        console.log('üì¶ Inicializando SessionManager...');
        sessionManager = new SessionManager();
    }
    
    const license = document.getElementById('activateLicense').value.trim();
    const teamName = document.getElementById('activateTeamName').value.trim();
    const coachName = document.getElementById('activateCoachName').value.trim();
    const password = document.getElementById('activatePassword').value;

    console.log('üìù Datos:', { license, teamName, coachName, passwordLength: password.length });

    if (!license || !teamName || !coachName || !password) {
        showError('activateError', 'Completa todos los campos');
        return;
    }

    try {
        console.log('üöÄ Activando licencia...');
        currentTeamId = teamManager.activateLicense(license, teamName, coachName, password);
        console.log('‚úÖ Licencia activada. TeamId:', currentTeamId);
        
        sessionManager.create('coach', currentTeamId, currentTeamId);
        console.log('‚úÖ Sesi√≥n creada');
        
        initManagers();
        console.log('‚úÖ Managers inicializados');
        
        showApp();
        console.log('‚úÖ App mostrada');
    } catch (error) {
        console.error('‚ùå Error en activaci√≥n:', error);
        showError('activateError', error.message);
    }
}
        sessionManager.create('coach', currentTeamId, currentTeamId);
        initManagers();
        showApp();
    } catch (error) {
        showError('activateError', error.message);
    }
}

// Show App
function showApp() {
    document.getElementById('authScreen').classList.add('hidden');
    document.getElementById('appScreen').classList.add('show');
    
    const team = teamManager.getTeam(currentTeamId);
    document.getElementById('teamNameDisplay').textContent = team.teamName;
    
    loadDashboard();
}

// Load Dashboard
function loadDashboard() {
    updateStats();
    loadPlayersGrid();
    loadPlayersTable();
    loadAlerts();
}

// Update Stats
function updateStats() {
    const players = playerManager.getActive();
    const todayCheckIns = checkInManager.getToday();
    const alerts = alertManager.getActive();

    document.getElementById('statTotalPlayers').textContent = players.length;
    document.getElementById('statCompletedToday').textContent = todayCheckIns.length;
    
    let available = 0;
    todayCheckIns.forEach(checkIn => {
        const status = Utils.getPlayerStatus(checkIn);
        if (status.status === 'good') available++;
    });
    document.getElementById('statAvailable').textContent = available;
    document.getElementById('statAlerts').textContent = alerts.length;
}

// Load Players Grid
function loadPlayersGrid() {
    const players = playerManager.getActive();
    const todayCheckIns = checkInManager.getToday();
    const grid = document.getElementById('playersGrid');
    grid.innerHTML = '';

    players.forEach(player => {
        const checkIn = todayCheckIns.find(c => c.playerId === player.id);
        const status = Utils.getPlayerStatus(checkIn);

        const card = document.createElement('div');
        card.className = `player-card ${status.status}`;
        card.innerHTML = `
            <div class="player-header">
                <div class="player-info">
                    <div class="player-name">${player.name}</div>
                    <span class="player-number">#${player.number}</span>
                </div>
                <div class="player-status">${status.icon}</div>
            </div>
            <div class="player-details">
                ${checkIn ? `
                    <div><strong>Estado f√≠sico:</strong> ${checkIn.data.physicalState}/10</div>
                    <div><strong>Estado mental:</strong> ${checkIn.data.mentalState}/10</div>
                    <div><strong>Dolor:</strong> ${checkIn.data.hasPain ? 'S√≠' : 'No'}</div>
                    <div><strong>Hora:</strong> ${checkIn.submitTime}</div>
                ` : '<div style="color:#ef4444;">‚è∞ Pendiente de check-in</div>'}
            </div>
            <div class="player-actions">
                <button class="btn-small" onclick="viewPlayerDetails('${player.id}')">Ver Detalles</button>
            </div>
        `;
        grid.appendChild(card);
    });
}

// Filter Players
function filterPlayers() {
    const filter = document.getElementById('filterStatus').value;
    const cards = document.querySelectorAll('.player-card');
    
    cards.forEach(card => {
        if (filter === 'all' || card.classList.contains(filter)) {
            card.style.display = 'block';
        } else {
            card.style.display = 'none';
        }
    });
}

// Load Players Table
function loadPlayersTable() {
    const players = playerManager.getActive();
    const tbody = document.getElementById('playersTableBody');
    tbody.innerHTML = '';

    players.forEach(player => {
        const row = document.createElement('tr');
        const lastCheckIn = player.lastCheckIn ? Utils.formatTime(player.lastCheckIn) : 'Nunca';
        
        row.innerHTML = `
            <td>${player.name}</td>
            <td>#${player.number}</td>
            <td>${player.position || '-'}</td>
            <td><strong>${player.pin}</strong></td>
            <td>${lastCheckIn}</td>
            <td>
                <button class="btn-small" onclick="regeneratePin('${player.id}')">üîÑ PIN</button>
                <button class="btn-small" style="background:#ef4444;" onclick="deletePlayer('${player.id}')">üóëÔ∏è</button>
            </td>
        `;
        tbody.appendChild(row);
    });
}

// Load Alerts
function loadAlerts() {
    const alerts = alertManager.getActive();
    const container = document.getElementById('alertsList');
    
    if (alerts.length === 0) {
        container.innerHTML = '<p style="text-align:center; color:#6b7280; padding:40px;">No hay alertas activas üéâ</p>';
        return;
    }

    container.innerHTML = '';
    alerts.forEach(alert => {
        const div = document.createElement('div');
        div.className = `alert ${alert.severity}`;
        div.innerHTML = `
            <div class="alert-header">
                <div><strong>${alert.playerName}</strong> - ${alert.message}</div>
                <button class="btn-small" onclick="resolveAlert('${alert.id}')">‚úì Resolver</button>
            </div>
            <div class="alert-time">${Utils.formatTime(alert.date)}</div>
        `;
        container.appendChild(div);
    });
}

// View Player Details
function viewPlayerDetails(playerId) {
    const player = playerManager.getById(playerId);
    const checkIns = checkInManager.getByPlayer(playerId, 7);
    
    document.getElementById('playerDetailsName').textContent = player.name + ' #' + player.number;
    
    let html = '<div style="margin-bottom:20px;">';
    html += `<p><strong>PIN:</strong> ${player.pin}</p>`;
    html += `<p><strong>Posici√≥n:</strong> ${player.position || '-'}</p>`;
    html += '</div>';
    
    html += '<h3 style="margin-bottom:15px;">√öltimos Check-ins (7 d√≠as)</h3>';
    
    if (checkIns.length === 0) {
        html += '<p>No hay check-ins recientes</p>';
    } else {
        checkIns.reverse().forEach(checkIn => {
            const status = Utils.getPlayerStatus(checkIn);
            html += `
                <div style="background:#f9fafb; padding:15px; border-radius:8px; margin-bottom:10px; border-left:4px solid ${status.color};">
                    <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                        <strong>${Utils.formatDate(checkIn.date)}</strong>
                        <span>${checkIn.submitTime}</span>
                    </div>
                    <div style="font-size:0.9em; color:#6b7280;">
                        <div>Estado f√≠sico: ${checkIn.data.physicalState}/10 ${Utils.getEmoji(checkIn.data.physicalState)}</div>
                        <div>Estado mental: ${checkIn.data.mentalState}/10 ${Utils.getEmoji(checkIn.data.mentalState)}</div>
                        <div>Sue√±o: ${checkIn.data.sleepHours}h</div>
                        ${checkIn.data.hasPain ? '<div style="color:#ef4444;">‚ö†Ô∏è Report√≥ dolor</div>' : ''}
                        ${checkIn.data.comments ? `<div style="margin-top:8px;"><em>"${checkIn.data.comments}"</em></div>` : ''}
                    </div>
                </div>
            `;
        });
    }
    
    document.getElementById('playerDetailsContent').innerHTML = html;
    showModal('playerDetailsModal');
}

// Add Player Modal
function showAddPlayerModal() {
    document.getElementById('newPlayerName').value = '';
    document.getElementById('newPlayerNumber').value = '';
    document.getElementById('newPlayerPosition').value = '';
    showModal('addPlayerModal');
}

// Add Player
function addPlayer() {
    const name = document.getElementById('newPlayerName').value.trim();
    const number = document.getElementById('newPlayerNumber').value;
    const position = document.getElementById('newPlayerPosition').value.trim();

    if (!name || !number) {
        showError('addPlayerError', 'Completa nombre y dorsal');
        return;
    }

    try {
        playerManager.add(name, number, position);
        closeModal('addPlayerModal');
        loadDashboard();
    } catch (error) {
        showError('addPlayerError', error.message);
    }
}

// Delete Player
function deletePlayer(playerId) {
    if (confirm('¬øSeguro que quieres desactivar este jugador?')) {
        playerManager.delete(playerId);
        loadDashboard();
    }
}

// Regenerate PIN
function regeneratePin(playerId) {
    const player = playerManager.regeneratePin(playerId);
    alert(`Nuevo PIN para ${player.name}: ${player.pin}`);
    loadPlayersTable();
}

// Resolve Alert
function resolveAlert(alertId) {
    alertManager.markAsResolved(alertId);
    loadAlerts();
    updateStats();
}

// Settings
function showSettings() {
    const team = teamManager.getTeam(currentTeamId);
    document.getElementById('settingsHour').value = team.settings.deadlineHour;
    document.getElementById('settingsMinutes').value = team.settings.deadlineMinutes;
    showModal('settingsModal');
}

function saveSettings() {
    const hour = parseInt(document.getElementById('settingsHour').value);
    const minutes = parseInt(document.getElementById('settingsMinutes').value);
    
    teamManager.updateTeamSettings(currentTeamId, {
        deadlineHour: hour,
        deadlineMinutes: minutes
    });
    
    closeModal('settingsModal');
    alert('Configuraci√≥n guardada');
}

// Switch Tab
function switchTab(tab) {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    event.target.classList.add('active');
    
    document.getElementById('dashboardTab').style.display = tab === 'dashboard' ? 'block' : 'none';
    document.getElementById('playersTab').style.display = tab === 'players' ? 'block' : 'none';
    document.getElementById('alertsTab').style.display = tab === 'alerts' ? 'block' : 'none';
}

// Modal Utils
function showModal(modalId) {
    document.getElementById(modalId).classList.add('show');
}

function closeModal(modalId) {
    document.getElementById(modalId).classList.remove('show');
}

function showError(elementId, message) {
    const el = document.getElementById(elementId);
    el.textContent = message;
    el.classList.add('show');
    setTimeout(() => el.classList.remove('show'), 5000);
}

// Logout
function logout() {
    if (confirm('¬øCerrar sesi√≥n?')) {
        sessionManager.clear();
        location.reload();
    }
}
</script>
</body>
</html>
